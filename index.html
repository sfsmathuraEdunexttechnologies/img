<!DOCTYPE html>
<html>

<head>
    <title>AES-256-CBC Image Decryptor</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #f2f2f2;
        }

        .box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            margin: auto;
            box-shadow: 0 0 10px #ccc;
        }

        input {
            margin: 10px 0;
        }

        img {
            max-width: 100%;
            margin-top: 20px;
            border-radius: 10px;
        }
    </style>
</head>

<body>
    <div class="box">
        <h2>AES-256-CBC Image Decryptor</h2>

        <label>Upload .enc File:</label><br>
        <input type="file" id="encFile"><br>

        <label>Upload metadata JSON:</label><br>
        <input type="file" id="jsonFile"><br>

        <button onclick="decryptNow()">Decrypt</button>

        <div id="status"></div>

        <img id="outputImage" style="display:none;">
    </div>
    <script>
        async function decryptNow() {
            const encInput = document.getElementById("encFile").files[0];
            const jsonInput = document.getElementById("jsonFile").files[0];
            const status = document.getElementById("status");

            if (!encInput || !jsonInput) {
                status.innerHTML = "<p style='color:red'>Please select both files.</p>";
                return;
            }

            // Read encrypted file
            const encryptedArrayBuffer = await encInput.arrayBuffer();

            // Read metadata JSON
            const jsonText = await jsonInput.text();
            const meta = JSON.parse(jsonText);

            // ⚠ IMPORTANT: Remove spaces, newlines, tabs, etc.
            const keyHex = meta.key.replace(/[^a-fA-F0-9]/g, "");
            const ivHex = meta.iv.replace(/[^a-fA-F0-9]/g, "");

            // Convert hex → Uint8Array
            function hexToBytes(hex) {
                const bytes = new Uint8Array(hex.length / 2);
                for (let i = 0; i < hex.length; i += 2) {
                    bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
                }
                return bytes;
            }

            const keyBytes = hexToBytes(keyHex);
            const ivBytes = hexToBytes(ivHex);

            console.log("Key length:", keyBytes.length, "bytes");
            console.log("IV length:", ivBytes.length, "bytes");

            // Import AES key
            const cryptoKey = await crypto.subtle.importKey(
                "raw",
                keyBytes,
                { name: "AES-CBC" },
                false,
                ["decrypt"]
            );

            try {
                const decryptedBuffer = await crypto.subtle.decrypt(
                    { name: "AES-CBC", iv: ivBytes },
                    cryptoKey,
                    encryptedArrayBuffer
                );

                const blob = new Blob([decryptedBuffer]);
                const imgURL = URL.createObjectURL(blob);

                const img = document.getElementById("outputImage");
                img.src = imgURL;
                img.style.display = "block";

                status.innerHTML = "<p style='color:green'>✔ Image successfully decrypted!</p>";

            } catch (err) {
                console.error(err);
                status.innerHTML = "<p style='color:red'>❌ Decryption failed (wrong key/IV or corrupted file)</p>";
            }
        }
    </script>

</body>

</html>
